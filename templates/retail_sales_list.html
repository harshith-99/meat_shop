{% load static %}
{% include "sidebar/sidebar.html" %}
{% load humanize %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800">Retail Sales Report</h1>

    <!-- FILTER FORM -->
    <div class="card shadow mb-3">
        <div class="card-body">
            <form method="get">
                <div class="row g-2 align-items-end">
                    {% if is_admin_like %}
                    <div class="col-md-3">
                        <label class="form-label">Branch</label>
                        <select name="branch" class="form-select form-select-sm">
                            <option value="" {% if not selected_branch %}selected{% endif %}>All Branches</option>
                            {% for b in branches %}
                            <option value="{{ b.branch_id }}" {% if selected_branch == b.branch_id %}selected{% endif %}>
                                {{ b.branch_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    <div class="col-md-2">
                        <label class="form-label">From Date</label>
                        <input type="date" name="from_date" value="{{ from_date_str }}" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">To Date</label>
                        <input type="date" name="to_date" value="{{ to_date_str }}" class="form-control form-control-sm">
                    </div>
                    <div class="col">
                        <button type="submit" class="btn btn-primary btn-sm">Filter</button>
                        <a href="{% url 'retail_sales_list' %}" class="btn btn-secondary btn-sm">Today</a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- FILTER SUMMARY -->
    <div class="card shadow mb-3">
        <div class="card-body p-3">
            <div class="row text-sm">
                <div class="col">
                    <strong>Branch:</strong> {{ selected_branch_name|default:"All Branches" }}
                </div>
                <div class="col">
                    <strong>Date:</strong> {{ from_date|date:"d-m-Y" }} to {{ to_date|date:"d-m-Y" }}
                </div>
            </div>
        </div>
    </div>

    <!-- 1) CREDIT BILLS SECTION -->
    {% if credit_sales.exists %}
    <div class="card shadow mb-4 border-danger">
        <div class="card-header bg-danger text-white py-3">
            <h6 class="m-0 font-weight-bold">Pending Credit Bills</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm table-bordered table-striped">
                    <thead class="table-danger">
                        <tr>
                            <th>Receipt</th>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Delivered By</th>
                            <th>Total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in credit_sales %}
                        <tr>
                            <td>{{ s.receipt_no }}</td>
                            <td>{{ s.sales_date|date:"d/m/Y" }}</td>
                            <td>{{ s.customer.customer_name|default:"Walk-in" }}</td>
                             <td>{{ s.take_amay_employee.name|default:"Walk-in" }}</td>
                            <td class="text-end text-danger fw-bold">₹{{ s.grand_total|floatformat:2|intcomma }}</td>
                            <td>
                                <button type="button" class="btn btn-success btn-sm" 
                                        onclick="openPayModal('{{ s.pk }}', '{{ s.receipt_no }}', '{{ s.customer.customer_name|default:'Walk-in' }}', '{{ s.grand_total }}')">
                                    Pay Now
                                </button>
                                <!-- <a href="{% url 'retail_receipt' s.pk %}?duplicate=1" target="_blank" class="btn btn-info btn-sm">Print</a> -->
                            </td>
                        </tr>
                        {% endfor %}
                        <tr class="table-secondary fw-bold">
                            <td colspan="4" class="text-end">TOTAL</td>

                            <td class="text-end">
                                ₹{{ credit_total_grand|floatformat:2|intcomma }}
                            </td>
                            <td></td>
                        </tr>

                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 2) REGULAR SALES TABLE + SUMMARY (same card) -->
    <div class="card shadow">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>Receipt</th>
                            <th>Date</th>
                            <th>Branch</th>
                            <th>Customer</th>
                            <th>Mode</th>
                            <th>Cash</th>
                            <th>Upi</th>
                            <th>Card</th>
                            <th>Pending</th>
                            <th>Sub Total</th>
                            <th>Discount</th>
                            <th>Grand Total</th>
                            {% if is_admin_like %}
                            <th>Created By</th>
                            {% endif %}
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in sales %}
                        <tr {% if s.payment_mode == 'pending' %}class="table-warning"{% endif %}>
                            <td>{{ s.receipt_no }}</td>
                            <td>{{ s.sales_date|date:"d/m/Y" }}</td>
                            <td>{{ s.branch.branch_name }}</td>
                            <td>{{ s.customer.customer_name|default:"Walk-in" }}</td>
                            <td>
                                <span class="badge 
                                    {% if s.payment_mode == 'cash' %}bg-success
                                    {% elif s.payment_mode == 'upi' %}bg-primary
                                    {% elif s.payment_mode == 'card' %}bg-info
                                    {% elif s.payment_mode == 'multiple' %}bg-info
                                    {% elif s.payment_mode == 'pending' %}bg-danger
                                    {% else %}bg-secondary{% endif %}">
                                    {{ s.get_payment_mode_display }}
                                </span>
                            </td>
                            <td class="text-end">₹{{ s.total_cash|floatformat:2|intcomma }}</td>
                            <td class="text-end">₹{{ s.total_upi|floatformat:2|intcomma }}</td>
                            <td class="text-end">₹{{ s.total_card|floatformat:2|intcomma }}</td>
                            <td class="text-end">₹{{ s.pending_amount|floatformat:2|intcomma }}</td>
                            <td class="text-end">₹{{ s.total|floatformat:2|intcomma }}</td>
                            <td class="text-end">₹{{ s.discount|default:0|floatformat:2|intcomma }}</td>
                            <td class="text-end">₹{{ s.grand_total|floatformat:2|intcomma }}</td>
                            {% if is_admin_like %}
                                <td>{{ s.added_by.get_full_name|default:s.added_by.username }}</td>
                            {% endif %}
                            <td>
                                <a href="{% url 'retail_receipt' s.pk %}?duplicate=1" target="_blank" class="btn btn-info btn-sm">
                                    Print
                                </a>
                                {% if is_admin_like %}
                                    <button type="button" onclick="deleteSale('{{ s.pk }}')" class="btn btn-danger btn-sm">
                                        Delete
                                    </button>
                                {% endif %}
                            </td>
                        </tr>

                        {% empty %}

                        <tr>
                            <td colspan="{% if is_admin_like %}8{% else %}6{% endif %}" class="text-center">
                                No sales found
                            </td>
                        </tr>
                        {% endfor %}
                        <tr class="table-secondary fw-bold">
                            <td colspan="5" class="text-end">TOTAL</td>

                            <td class="text-end">
                                ₹{{ total_cash|floatformat:2|intcomma }}
                            </td>

                             <td class="text-end">
                                ₹{{ total_upi|floatformat:2|intcomma }}
                            </td>

                            <td class="text-end">
                                ₹{{ total_card|floatformat:2|intcomma }}
                            </td>

                            <td class="text-end">
                                ₹{{ total_pending|floatformat:2|intcomma }}
                            </td>

                            <td class="text-end">
                                ₹{{ total_subtotal|floatformat:2|intcomma }}
                            </td>

                            <td class="text-end">
                                ₹{{ total_discount|floatformat:2|intcomma }}
                            </td>

                            <td class="text-end">
                                ₹{{ total_grand|floatformat:2|intcomma }}
                            </td>

                            {% if is_admin_like %}
                                <td></td>
                            {% endif %}
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- PAYMENT MODE SUMMARY (inside same card) -->
            <!-- <div class="mt-4">
                <h5 class="text-primary mb-3">Payment Summary ({{ from_date|date:"d-m-Y" }} to {{ to_date|date:"d-m-Y" }})</h5>
                <table class="table table-bordered table-sm w-auto ms-auto">
                    <tbody>
                        {% for mode, amount in payment_mode_totals.items %}
                        <tr>
                            <td class="text-start fw-bold ps-4">{{ mode }}</td>
                            <td class="text-end pe-4">₹{{ amount|floatformat:2|intcomma }}</td>
                        </tr>
                        {% endfor %}
                        <tr class="table-primary fw-bold fs-5">
                            <td class="text-start ps-4">Total Sales</td>
                            <td class="text-end pe-4">₹{{ total_grand|floatformat:2|intcomma }}</td>
                        </tr>
                    </tbody>
                </table>
            </div> -->
        </div>
    </div>
</div>

<!-- ====================== CUSTOM MODAL (Pure JavaScript) ====================== -->
<div id="customPayModal" 
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.6); z-index:1000; overflow:auto;">
    <div style="background:#fff; max-width:500px; margin:60px auto; 
            border-radius:8px; box-shadow:0 5px 15px rgba(0,0,0,0.5); 
            max-height:90vh; overflow-y:auto;">
        <div style="background:#28a745; color:white; padding:15px; font-size:18px; font-weight:bold;">
            Pay Credit Bill - <span id="modalReceiptNo"></span>
            <button type="button" onclick="closePayModal()" style="float:right; background:none; border:none; color:white; font-size:20px; cursor:pointer;">×</button>
        </div>
        <div style="padding:20px;">
            <p><strong>Customer:</strong> <span id="modalCustomerName"></span></p>
            <p><strong>Amount Due:</strong> ₹<span id="modalAmountDue"></span></p>

            <form id="payForm" method="post">
                {% csrf_token %}
                <input type="hidden" name="sale_id" id="modalSaleId">

                <input type="hidden" id="modalGrandTotal">

                <div style="margin-bottom:15px;">
                    <label style="font-weight:bold;">Payment Mode</label>
                    <select id="modalPaymentMode" name="payment_mode"
                        style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;" required>
                        <option value="cash">Cash</option>
                        <option value="upi">UPI</option>
                        <option value="card">Card</option>
                        <option value="multiple">Multiple</option>
                    </select>
                </div>

                <div style="margin-bottom:10px;">
                    <label>Cash</label>
                    <input type="number" step="0.01" id="modalCash" name="cash"
                        style="width:100%; padding:6px;">
                </div>

                <div style="margin-bottom:10px;">
                    <label>UPI</label>
                    <input type="number" step="0.01" id="modalUpi" name="upi"
                        style="width:100%; padding:6px;">
                </div>

                <div style="margin-bottom:10px;">
                    <label>Card</label>
                    <input type="number" step="0.01" id="modalCard" name="card"
                        style="width:100%; padding:6px;">
                </div>

                <div style="margin-bottom:15px;">
                    <label>Pending</label>
                    <input type="number" step="0.01" id="modalPending" name="pending"
                        style="width:100%; padding:6px; background:#f1f1f1;" readonly>
                </div>

                <div style="text-align:right;">
                    <button type="button" onclick="closePayModal()" 
                        style="padding:8px 16px; background:#6c757d; color:white; border:none; border-radius:4px;">
                        Cancel
                    </button>
                    <button type="submit"
                        style="padding:8px 16px; background:#28a745; color:white; border:none; border-radius:4px;">
                        Mark as Paid
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Open modal
function openPayModal(saleId, receiptNo, customerName, amountDue) {
    document.getElementById('modalSaleId').value = saleId;
    document.getElementById('modalReceiptNo').textContent = receiptNo;
    document.getElementById('modalCustomerName').textContent = customerName || 'Walk-in';
    document.getElementById('modalAmountDue').textContent = amountDue;
    document.getElementById('payForm').action = "/accounts/sales/retail/pay-credit/" + saleId + "/";
    initModalPayment(amountDue);
    document.getElementById("customPayModal").style.display = "block";
}

// Close modal
function closePayModal() {
    document.getElementById('customPayModal').style.display = 'none';
}

// Close on outside click
window.onclick = function(event) {
    const modal = document.getElementById('customPayModal');
    if (event.target === modal) closePayModal();
}

// Delete sale
function deleteSale(pk) {
    if (!confirm('Delete this sale? Stock will be restored.')) return;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch(`/accounts/sales/retail/delete/${pk}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/json' },
        body: JSON.stringify({})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) { alert('Sale deleted!'); location.reload(); }
        else { alert('Error: ' + (data.error || 'Failed')); }
    })
    .catch(() => alert('Network error.'));
}

function initModalPayment(amountDue) {

    amountDue = parseFloat(amountDue.toString().replace(/,/g, "")) || 0;

    $("#modalGrandTotal").val(amountDue.toFixed(2));

    $("#modalPaymentMode").val("cash");

    applyModalMode("cash");
}

function applyModalMode(mode) {

    let total = parseFloat($("#modalGrandTotal").val()) || 0;

    // Reset everything
    $("#modalCash, #modalUpi, #modalCard")
        .val("0.00")
        .prop("readonly", true);

    if (mode === "cash") {
        $("#modalCash").val(total.toFixed(2)).prop("readonly", false);
    }

    else if (mode === "upi") {
        $("#modalUpi").val(total.toFixed(2)).prop("readonly", false);
    }

    else if (mode === "card") {
        $("#modalCard").val(total.toFixed(2)).prop("readonly", false);
    }

    else if (mode === "multiple") {
        $("#modalCash, #modalUpi, #modalCard")
            .prop("readonly", false);
    }

    calculateModalPending();
}

function calculateModalPending() {

    let total = parseFloat($("#modalGrandTotal").val()) || 0;
    let cash = parseFloat($("#modalCash").val()) || 0;
    let upi = parseFloat($("#modalUpi").val()) || 0;
    let card = parseFloat($("#modalCard").val()) || 0;

    let paid = cash + upi + card;
    let pending = total - paid;

    if (pending < 0) pending = 0;

    $("#modalPending").val(pending.toFixed(2));
}

// Mode change
$("#modalPaymentMode").on("change", function() {
    applyModalMode($(this).val());
});

// Live calculation
$("#modalCash, #modalUpi, #modalCard").on("input", function() {
    calculateModalPending();
});

</script>

<style>
#customPayModal[style*="display: block"] { opacity: 1; transition: opacity 0.3s; }
#customPayModal { opacity: 0; transition: opacity 0.3s; }
</style>

{% endblock %}