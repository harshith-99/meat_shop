{% load static %}
{% include "sidebar/sidebar.html" %}
{% load humanize %}

{% block content %}
<div class="container-fluid">

    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Dashboard</h1>
        <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm">
            <i class="fas fa-download fa-sm text-white-50"></i> Generate Report
        </a>
    </div>

    <!-- Summary Cards -->
    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Sales (Today)</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">₹{{ today_sales|floatformat:2|intcomma }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-shopping-cart fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Total Purchase (Today)</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">₹{{ today_purchase|floatformat:2|intcomma }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-truck-loading fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Net Profit (Today)</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">₹{{ today_profit|floatformat:2|intcomma }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Pending Bill(Retail)</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">₹{{ pending_credit|floatformat:2|intcomma }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-comments fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Date Range & View</h6>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-3 col-sm-6">
                    <label>View</label>
                    <select name="period" class="form-control" id="periodSelect">
                        <option value="week" {% if period == 'week' %}selected{% endif %}>This Week</option>
                        <option value="month" {% if period == 'month' %}selected{% endif %}>This Month</option>
                        <option value="year" {% if period == 'year' %}selected{% endif %}>This Year</option>
                        <option value="custom" {% if period == 'custom' %}selected{% endif %}>Custom Range</option>
                    </select>
                </div>
                <div class="col-md-3 col-sm-6" id="fromDateGroup">
                    <label>From</label>
                    <input type="date" name="from_date" class="form-control" value="{{ from_date }}">
                </div>
                <div class="col-md-3 col-sm-6" id="toDateGroup">
                    <label>To</label>
                    <input type="date" name="to_date" class="form-control" value="{{ to_date }}">
                </div>
                <div class="col-md-3 col-sm-6 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Apply</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Row for Charts -->
    <div class="row">
        <!-- Earnings Overview -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Earnings Overview (Purchase vs Sales)</h6>
                </div>
                <div class="card-body">
                    <canvas id="earningsChart" height="280"></canvas>
                </div>
            </div>
        </div>

        <!-- Sales Breakdown -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-success">Sales Breakdown</h6>
                    <div>
                        <button class="btn btn-sm btn-outline-primary active" data-type="combined">Combined</button>
                        <button class="btn btn-sm btn-outline-info" data-type="retail">Retail</button>
                        <button class="btn btn-sm btn-outline-warning" data-type="wholesale">Wholesale</button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="salesChart" height="280"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Purchase Chart (Full Width, Smaller) -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-danger">Purchase Stock Value</h6>
                </div>
                <div class="card-body">
                    <canvas id="purchaseChart" height="220"></canvas>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Data from Django context
const labels = {{ labels|safe }};
const purchaseData = {{ purchase_data|safe }};
const retailSalesData = {{ retail_sales_data|safe }};
const wholesaleSalesData = {{ wholesale_sales_data|safe }};
const combinedSalesData = retailSalesData.map((r, i) => (r || 0) + (wholesaleSalesData[i] || 0));

// Common options for responsiveness
const chartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: { position: 'top' },
    },
    scales: {
        y: {
            beginAtZero: true,
            ticks: { callback: value => '₹' + value.toLocaleString('en-IN') }
        }
    }
};

// Earnings Overview Chart
new Chart(document.getElementById('earningsChart'), {
    type: 'line',
    data: {
        labels: labels,
        datasets: [
            {
                label: 'Total Purchase',
                data: purchaseData,
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                tension: 0.3,
                fill: true
            },
            {
                label: 'Total Sales',
                data: combinedSalesData,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.3,
                fill: true
            }
        ]
    },
    options: chartOptions
});

// Purchase Chart
new Chart(document.getElementById('purchaseChart'), {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [{
            label: 'Purchase Value',
            data: purchaseData,
            backgroundColor: 'rgba(255, 99, 132, 0.7)',
            borderColor: 'rgb(255, 99, 132)',
            borderWidth: 1
        }]
    },
    options: chartOptions
});

// Sales Breakdown Chart
let salesChart = new Chart(document.getElementById('salesChart'), {
    type: 'line',
    data: {
        labels: labels,
        datasets: [{
            label: 'Combined Sales',
            data: combinedSalesData,
            borderColor: 'rgb(54, 162, 235)',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            tension: 0.3,
            fill: true
        }]
    },
    options: chartOptions
});

// Toggle Sales Type
document.querySelectorAll('[data-type]').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('[data-type]').forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        const type = this.getAttribute('data-type');
        let data = combinedSalesData;
        let label = 'Combined Sales';
        let color = 'rgb(54, 162, 235)';

        if (type === 'retail') {
            data = retailSalesData;
            label = 'Retail Sales';
            color = 'rgb(75, 192, 192)';
        } else if (type === 'wholesale') {
            data = wholesaleSalesData;
            label = 'Wholesale Sales';
            color = 'rgb(255, 205, 86)';
        }

        salesChart.data.datasets[0].data = data;
        salesChart.data.datasets[0].label = label;
        salesChart.data.datasets[0].borderColor = color;
        salesChart.data.datasets[0].backgroundColor = color.replace('rgb', 'rgba').replace(')', ', 0.1)');
        salesChart.update();
    });
});

// Show/hide custom date inputs
document.getElementById('periodSelect').addEventListener('change', function() {
    const isCustom = this.value === 'custom';
    document.getElementById('fromDateGroup').style.display = isCustom ? 'block' : 'none';
    document.getElementById('toDateGroup').style.display = isCustom ? 'block' : 'none';
});

window.addEventListener('load', () => {
    const isCustom = "{{ period }}" === "custom";
    document.getElementById('fromDateGroup').style.display = isCustom ? 'block' : 'none';
    document.getElementById('toDateGroup').style.display = isCustom ? 'block' : 'none';
});
</script>
{% endblock %}