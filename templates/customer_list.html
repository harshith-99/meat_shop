{% load static %}
{% include "sidebar/sidebar.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Customer List</h2>

    {% if request.user.role == 'admin' or request.user.role == 'super_admin' or request.user.role == 'manager' %}
        <a href="{% url 'customer_add' %}" class="btn btn-success mb-3">+ Add Customer</a>
    {% endif %}

    <!-- Success Messages Only -->
    {% for message in messages %}
        {% if message.tags == 'success' %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}
    {% endfor %}

    <!-- Search Bar -->
    <div class="row mb-3">
        <div class="col-md-6">
            <input type="text" id="searchInput" class="form-control" placeholder="Search by Name, Phone, GSTIN or Address...">
        </div>
        <div class="col-md-6 text-end">
            <small class="text-muted">Total Customers: <strong>{{ customers|length }}</strong></small>
        </div>
    </div>

    <!-- Table with Sortable Headers -->
    <div class="table-responsive">
        <table class="table table-bordered table-hover" id="customerTable">
            <thead class="table-light">
                <tr>
                    <th class="sortable" data-sort="sno">S.No <i class="fas fa-sort ms-1"></i></th>
                    <th class="sortable" data-sort="name">Name <i class="fas fa-sort ms-1"></i></th>
                    <th class="sortable" data-sort="phone">Phone <i class="fas fa-sort ms-1"></i></th>
                    <th>Address</th>
                    <th class="sortable" data-sort="gstin">GSTIN <i class="fas fa-sort ms-1"></i></th>
                    <th class="sortable" data-sort="wholesale">Wholesale <i class="fas fa-sort ms-1"></i></th>
                    <th class="sortable" data-sort="wholesale">Opening Balance <i class="fas fa-sort ms-1"></i></th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="customerTableBody">
                {% for customer in customers %}
                <tr>
                    <td class="sno">{{ forloop.counter }}</td>
                    <td class="name">{{ customer.customer_name|default:"—" }}</td>
                    <td class="phone">{{ customer.customer_phone|default:"—" }}</td>
                    <td>{{ customer.customer_address|default:"—" }}</td>
                    <td class="gstin">{{ customer.gstin|default:"—" }}</td>
                    <td class="wholesale">
                        {% if customer.whole_sale %}
                            <span class="text-success fw-bold">Wholesale</span>
                        {% else %}
                            <span class="text-muted">Retail</span>
                        {% endif %}
                    </td>
                    <td class="gstin">{{ customer.opening_balance }}</td>
                    <td>
                        <a href="{% url 'customer_update' customer.pk %}" class="btn btn-warning btn-sm">Edit</a>
                        <a href="{% url 'customer_delete' customer.pk %}" class="btn btn-danger btn-sm ms-1"
                           onclick="return confirm('Delete this customer?');">Delete</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center py-4">No customers found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <nav aria-label="Customer pagination" class="mt-4">
        <ul class="pagination justify-content-center" id="pagination">
            <!-- Pagination links will be injected by JS -->
        </ul>
    </nav>
</div>

<!-- Font Awesome for sort icons (if not already loaded) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script>
document.addEventListener("DOMContentLoaded", function () {

    const tbody = document.getElementById("customerTableBody");
    const allRows = Array.from(tbody.querySelectorAll("tr"));
    const searchInput = document.getElementById("searchInput");
    const pagination = document.getElementById("pagination");

    let currentPage = 1;
    const rowsPerPage = 10;
    let sortColumn = null;
    let sortDirection = "asc";

    /* ───────── Helper to get cell value ───────── */
    function getValue(row, col) {
        switch (col) {
            case "sno":
                return parseInt(row.querySelector(".sno").textContent);
            case "name":
                return row.querySelector(".name").textContent.toLowerCase();
            case "phone":
                return row.querySelector(".phone").textContent;
            case "gstin":
                return row.querySelector(".gstin").textContent;
            case "wholesale":
                return row.querySelector(".wholesale").textContent.includes("Wholesale") ? 1 : 0;
            default:
                return "";
        }
    }

    /* ───────── Filter + Sort FULL data ───────── */
    function getProcessedRows() {
        let rows = [...allRows];

        // SEARCH
        const q = searchInput.value.toLowerCase();
        if (q) {
            rows = rows.filter(row => {
                return (
                    row.querySelector(".name").textContent.toLowerCase().includes(q) ||
                    row.querySelector(".phone").textContent.toLowerCase().includes(q) ||
                    row.querySelector(".gstin").textContent.toLowerCase().includes(q) ||
                    row.querySelector("td:nth-child(4)").textContent.toLowerCase().includes(q)
                );
            });
        }

        // SORT
        if (sortColumn) {
            rows.sort((a, b) => {
                let A = getValue(a, sortColumn);
                let B = getValue(b, sortColumn);

                if (typeof A === "number") {
                    return sortDirection === "asc" ? A - B : B - A;
                }
                return sortDirection === "asc"
                    ? A.localeCompare(B)
                    : B.localeCompare(A);
            });
        }

        return rows;
    }

    /* ───────── Render table (ONLY slice here) ───────── */
    function renderTable(rows) {
        tbody.innerHTML = "";

        if (rows.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" class="text-center">No customers found</td></tr>`;
            pagination.innerHTML = "";
            return;
        }

        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageRows = rows.slice(start, end);

        pageRows.forEach((row, index) => {
            const clone = row.cloneNode(true);
            clone.querySelector(".sno").textContent =
                index + 1 + start;
            tbody.appendChild(clone);
        });

        renderPagination(rows.length);
    }

    /* ───────── Pagination (FIXED) ───────── */
    function renderPagination(totalRows) {
        pagination.innerHTML = "";
        const totalPages = Math.ceil(totalRows / rowsPerPage);
        if (totalPages <= 1) return;

        // Prev
        pagination.innerHTML += `
            <li class="page-item ${currentPage === 1 ? "disabled" : ""}">
                <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
            </li>`;

        // Pages
        for (let i = 1; i <= totalPages; i++) {
            pagination.innerHTML += `
                <li class="page-item ${i === currentPage ? "active" : ""}">
                    <a class="page-link" href="#" data-page="${i}">${i}</a>
                </li>`;
        }

        // Next
        pagination.innerHTML += `
            <li class="page-item ${currentPage === totalPages ? "disabled" : ""}">
                <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
            </li>`;
    }

    /* ───────── Update View ───────── */
    function updateView() {
        const processed = getProcessedRows();
        renderTable(processed);
    }

    /* ───────── Events ───────── */
    searchInput.addEventListener("input", () => {
        currentPage = 1;
        updateView();
    });

    document.querySelectorAll(".sortable").forEach(th => {
        th.addEventListener("click", () => {
            const col = th.dataset.sort;
            if (sortColumn === col) {
                sortDirection = sortDirection === "asc" ? "desc" : "asc";
            } else {
                sortColumn = col;
                sortDirection = "asc";
            }
            currentPage = 1;
            updateView();
        });
    });

    pagination.addEventListener("click", e => {
        e.preventDefault();
        const link = e.target.closest("a");
        if (!link) return;
        const page = parseInt(link.dataset.page);
        if (!isNaN(page)) {
            currentPage = page;
            updateView();
        }
    });

    /* ───────── Initial Load ───────── */
    updateView();
});
</script>



{% endblock %}